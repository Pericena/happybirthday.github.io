<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Mockup - Bot de Ciberseguridad (Millicom)</title>
  <!-- Tailwind CDN (play) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* pequeñas personalizaciones */
    .glass { background: rgba(255,255,255,0.06); backdrop-filter: blur(6px); }
    .accent { background: linear-gradient(90deg,#0ea5a4,#7c3aed); -webkit-background-clip: text; color: transparent; }
    pre.snippet { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", monospace; white-space: pre-wrap; word-break: break-word; }
  </style>
</head>
<body class="bg-gray-900 text-gray-100 antialiased">
  <div class="min-h-screen flex items-center justify-center p-6">
    <div class="w-full max-w-6xl grid grid-cols-12 gap-6">

      <!-- Left: Controls & chat -->
      <div class="col-span-7 glass rounded-2xl p-6 shadow-lg border border-white/6">
        <header class="flex items-center justify-between mb-4">
          <div>
            <h1 class="text-2xl font-semibold">Bot de Ciberseguridad — <span class="accent">Millicom</span></h1>
            <p class="text-sm text-gray-400 mt-1">Simulación RAG: respuestas con respaldo en PDFs, % confianza y referencias.</p>
          </div>
          <div class="text-right">
            <span class="inline-flex items-center gap-2 bg-white/5 px-3 py-1 rounded-full text-sm">
              <svg class="w-4 h-4 text-teal-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16h6" /></svg>
              Simulación
            </span>
          </div>
        </header>

        <!-- PDF repository panel (mock) -->
        <section class="mb-4">
          <h2 class="text-sm text-gray-300 font-medium">Repositorio documental (mock)</h2>
          <div class="mt-2 grid grid-cols-3 gap-2">
            <div class="p-3 bg-gray-800 rounded-lg border border-white/3">
              <div class="text-xs text-gray-400">Millicom_Policies.pdf</div>
              <div class="font-medium mt-1 text-sm">Política de privacidad</div>
              <div class="text-xs text-gray-400 mt-2">Sección: 4.2 — Notificaciones de incidentes</div>
            </div>
            <div class="p-3 bg-gray-800 rounded-lg border border-white/3">
              <div class="text-xs text-gray-400">ISO27001.pdf</div>
              <div class="font-medium mt-1 text-sm">Control A.18.1.3</div>
              <div class="text-xs text-gray-400 mt-2">Gestión de incidentes y comunicación</div>
            </div>
            <div class="p-3 bg-gray-800 rounded-lg border border-white/3">
              <div class="text-xs text-gray-400">NIST_CSF.pdf</div>
              <div class="font-medium mt-1 text-sm">PR.DS / RS</div>
              <div class="text-xs text-gray-400 mt-2">Privacidad y comunicación</div>
            </div>
          </div>
        </section>

        <!-- Query box -->
        <section class="mb-4">
          <label class="text-xs text-gray-400">Pregunta de ciberseguridad</label>
          <div class="mt-2 flex gap-2">
            <input id="question" type="text" placeholder="Ej: ¿Qué hacemos ante una fuga de datos de clientes?" class="flex-1 bg-transparent border border-white/6 rounded-xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-teal-400"/>
            <button id="askBtn" class="rounded-xl px-4 py-3 bg-gradient-to-r from-teal-400 to-violet-600 text-black font-semibold hover:scale-[1.02]">Consultar</button>
          </div>
          <div class="mt-2 flex items-center gap-3 text-xs text-gray-400">
            <div class="flex items-center gap-2">
              <input id="useMock" type="checkbox" checked class="h-4 w-4 rounded bg-gray-700"/>
              <label for="useMock">Simular respuesta (sin backend)</label>
            </div>
            <div class="text-amber-400">Tip: cuando conectes Flask, desmarca esto y apunta a tu `/ask`</div>
          </div>
        </section>

        <!-- Chat / response -->
        <section id="responseCard" class="mt-4 p-4 bg-gradient-to-br from-white/3 to-white/2 rounded-2xl border border-white/6 shadow-inner hidden">
          <div class="flex items-start gap-4">
            <div class="w-12 h-12 rounded-lg bg-gradient-to-tr from-violet-600 to-teal-400 flex items-center justify-center text-black font-bold">CS</div>
            <div class="flex-1">
              <div class="flex items-center justify-between">
                <div>
                  <div id="labelTag" class="inline-flex px-3 py-1 rounded-full text-xs font-semibold bg-white/6 text-white">Etiqueta: <span id="etiqueta" class="ml-2 font-medium">Incidente</span></div>
                </div>
                <div class="text-right">
                  <div class="text-xs text-gray-300">Confianza</div>
                  <div class="mt-1 flex items-center gap-2">
                    <div id="confVal" class="text-sm font-semibold">—%</div>
                    <div class="w-40 bg-white/6 rounded-full h-2 overflow-hidden">
                      <div id="confBar" class="h-2 bg-gradient-to-r from-teal-400 to-violet-600 rounded-full w-0"></div>
                    </div>
                  </div>
                </div>
              </div>

              <div class="mt-3 text-gray-200" id="answerText">
                <!-- respuesta -->
              </div>

              <div class="mt-3">
                <div class="text-sm text-gray-300 font-medium">Pasos recomendados</div>
                <ul id="stepsList" class="mt-2 list-inside list-decimal text-gray-200 space-y-1"></ul>
              </div>

              <div class="mt-3 grid grid-cols-2 gap-3">
                <div>
                  <div class="text-sm text-gray-300 font-medium">Referencias (fuente y página)</div>
                  <div id="refs" class="mt-2 space-y-2 text-sm text-gray-200"></div>
                </div>
                <div>
                  <div class="text-sm text-gray-300 font-medium">Snippets usados</div>
                  <div id="snips" class="mt-2 space-y-2 text-sm text-gray-200"></div>
                </div>
              </div>

            </div>
          </div>
        </section>

        <!-- Conversation history (simple) -->
        <section class="mt-5">
          <h3 class="text-sm text-gray-400 mb-2">Historial (últimas preguntas)</h3>
          <div id="history" class="space-y-3 text-sm text-gray-300"></div>
        </section>
      </div>

      <!-- Right: Info & simulated internals -->
      <aside class="col-span-5 glass rounded-2xl p-6 shadow-lg border border-white/6">
        <h3 class="text-lg font-semibold">Internals (simulación)</h3>
        <p class="text-sm text-gray-400 mt-2">Muestra cómo trabaja el RAG: fragmentos recuperados, score de similitud y prompt enviado al LLM.</p>

        <div class="mt-4">
          <div class="text-xs text-gray-400">Fragmentos recuperados</div>
          <div id="fragList" class="mt-2 space-y-3">
            <!-- fragments -->
          </div>
        </div>

        <div class="mt-4">
          <div class="text-xs text-gray-400">Prompt enviado a Gemini (simulado)</div>
          <pre id="promptBox" class="mt-2 p-3 bg-gray-800 rounded-lg text-xs text-gray-200 overflow-auto max-h-44"></pre>
        </div>

        <div class="mt-4">
          <div class="text-xs text-gray-400">Ajustes</div>
          <div class="mt-2 grid grid-cols-2 gap-2">
            <label class="text-xs text-gray-300">k (fragments)</label>
            <input id="kVal" type="number" value="3" min="1" max="8" class="bg-gray-800 px-2 py-1 rounded"/>
            <label class="text-xs text-gray-300">Confianza mínima (%)</label>
            <input id="minConf" type="number" value="40" min="0" max="100" class="bg-gray-800 px-2 py-1 rounded"/>
          </div>
        </div>

        <div class="mt-6">
          <div class="text-xs text-gray-400">Conectar con Flask</div>
          <div class="mt-2 text-sm text-gray-300">Para conectar con tu backend Flask: cambia <code class="bg-gray-800 p-1 rounded">useMock = true</code> en el script o modifica la función <code class="bg-gray-800 p-1 rounded">callBackend()</code>.</div>
        </div>

      </aside>

    </div>
  </div>

  <!-- JS: lógica de simulación y UI -->
  <script>
    // Mock documental: fragmentos pre-cargados (simulan chunks indexados)
    const MOCK_FRAGMENTS = [
      {
        source: "Millicom_Policies.pdf",
        page: 12,
        snippet: "Sección 4.2: En caso de incidentes que involucren fuga de datos, se debe activar el Plan de Respuesta a Incidentes, notificar al área de Compliance y reportar a la autoridad correspondiente.",
        embScore: 0.89
      },
      {
        source: "ISO27001.pdf",
        page: "A.18.1.3",
        snippet: "Control A.18.1.3: La organización debe preparar procedimientos documentados para la gestión y comunicación de incidentes de seguridad de la información.",
        embScore: 0.84
      },
      {
        source: "NIST_CSF.pdf",
        page: "RS-1",
        snippet: "NIST RS.CO-2: La comunicación durante y después de un incidente debe ser coordinada y seguir procesos establecidos.",
        embScore: 0.78
      }
    ];

    // UI elementos
    const askBtn = document.getElementById('askBtn');
    const questionInput = document.getElementById('question');
    const useMockChk = document.getElementById('useMock');
    const responseCard = document.getElementById('responseCard');
    const etiquetaEl = document.getElementById('etiqueta');
    const answerText = document.getElementById('answerText');
    const stepsList = document.getElementById('stepsList');
    const refs = document.getElementById('refs');
    const snips = document.getElementById('snips');
    const confVal = document.getElementById('confVal');
    const confBar = document.getElementById('confBar');
    const historyEl = document.getElementById('history');
    const fragList = document.getElementById('fragList');
    const promptBox = document.getElementById('promptBox');
    const kVal = document.getElementById('kVal');
    const minConf = document.getElementById('minConf');

    // guarda historial simple en memoria (sin DB)
    const HISTORY = [];

    // genera el prompt que enviarías al LLM (simulado)
    function buildPrompt(question, fragments) {
      let ctx = fragments.map(f => `[fuente: ${f.source} | página: ${f.page}]\n${f.snippet}`).join("\n\n");
      return `Eres un asistente de Ciberseguridad. Responde SOLO usando el contexto. \n\nPREGUNTA: ${question}\n\nCONTEXTO:\n${ctx}\n\nDevuelve JSON con: etiqueta, respuesta, pasos_recomendados (array).`;
    }

    // Simula la respuesta del LLM basándose en fragments
    function simulateResponse(question, k) {
      // tomamos top-k fragments por embScore
      const frags = MOCK_FRAGMENTS.slice().sort((a,b) => b.embScore - a.embScore).slice(0,k);
      const avgScore = (frags.reduce((s,f)=>s+f.embScore,0))/frags.length;
      const confidencePct = Math.round(avgScore*10000)/100; // 2 decimales

      // etiqueta heurística simple
      const etiqueta = /fuga|filtración|exfiltración|datos/i.test(question) ? "Incidente" : "Política";

      // respuesta sintetizada (simulada)
      const respuesta = `Según los documentos indexados, ante una fuga de datos debe activarse el Plan de Respuesta a Incidentes, notificar a Compliance, contener la fuga y documentar la cadena de custodia.`;

      const pasos = [
        "Activar plan de respuesta a incidentes y equipo SOC",
        "Contener el vector de fuga (aislar cuentas, revocar accesos, detener exfiltración)",
        "Notificar a Compliance y al comité de seguridad (según política Millicom)",
        "Documentar evidencia y comunicaciones; preparar reporte para auditoría",
        "Revisar controles y aplicar lecciones aprendidas"
      ];

      return {
        etiqueta, respuesta, pasos, confidencePct, frags,
        prompt: buildPrompt(question, frags)
      };
    }

    // Render fragments list in the right panel
    function renderFragments(frags) {
      fragList.innerHTML = "";
      frags.forEach(f=>{
        const el = document.createElement('div');
        el.className = "p-3 bg-gray-800 rounded-lg border border-white/3 text-sm";
        el.innerHTML = `<div class="text-xs text-gray-400">${f.source} • página ${f.page}</div>
                        <div class="mt-1 text-gray-200 pre-wrap">${f.snippet}</div>
                        <div class="mt-2 text-xs text-gray-400">score: ${Math.round(f.embScore*1000)/10}%</div>`;
        fragList.appendChild(el);
      });
    }

    // fill the UI with the response object
    function showResponse(res) {
      responseCard.classList.remove('hidden');
      etiquetaEl.textContent = res.etiqueta;
      answerText.textContent = res.respuesta;

      // pasos
      stepsList.innerHTML = "";
      res.pasos.slice(0,5).forEach(p=>{
        const li = document.createElement('li');
        li.textContent = p;
        stepsList.appendChild(li);
      });

      // references
      refs.innerHTML = "";
      res.frags.forEach(f=>{
        const d = document.createElement('div');
        d.className = "p-2 bg-gray-800 rounded text-xs";
        d.innerHTML = `<strong class="text-gray-200">${f.source}</strong><div class="text-gray-400">p.${f.page}</div>`;
        refs.appendChild(d);
      });

      // snippets
      snips.innerHTML = "";
      res.frags.forEach(f=>{
        const s = document.createElement('pre');
        s.className = "snippet p-2 bg-gray-800 rounded";
        s.textContent = f.snippet;
        snips.appendChild(s);
      });

      // confiance bar
      confVal.textContent = res.confidencePct + "%";
      confBar.style.width = Math.min(res.confidencePct, 100) + "%";

      // prompt
      promptBox.textContent = res.prompt;

      // fragments list right
      renderFragments(res.frags);

      // historial
      HISTORY.unshift({q: questionInput.value, etiqueta: res.etiqueta, conf: res.confidencePct});
      renderHistory();
    }

    function renderHistory() {
      historyEl.innerHTML = "";
      HISTORY.slice(0,6).forEach(h=>{
        const e = document.createElement('div');
        e.className = "p-2 bg-gray-800 rounded flex items-center justify-between";
        e.innerHTML = `<div><div class="text-sm text-gray-200">${h.q}</div><div class="text-xs text-gray-400">${h.etiqueta}</div></div>
                       <div class="text-sm font-semibold">${h.conf}%</div>`;
        historyEl.appendChild(e);
      });
    }

    // callBackend: if connected, here is where you'd call /ask. Right now it uses simulateResponse.
    async function callBackend(question, k, useMock=true) {
      if (useMock) {
        // simulación local
        return simulateResponse(question, k);
      } else {
        // con backend real (ejemplo):
        // const resp = await fetch("http://localhost:5000/ask", { method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify({question})});
        // const data = await resp.json();
        // return data; // adapt to la estructura que uses
        throw new Error("Modo no-mock no implementado en demo. Cambia el código para tu endpoint.");
      }
    }

    // handler del botón
    askBtn.addEventListener('click', async ()=>{
      const q = questionInput.value.trim();
      if (!q) return alert("Escribe una pregunta.");
      const k = parseInt(kVal.value || "3", 10);
      const minC = parseInt(minConf.value || "40", 10);
      const useMock = useMockChk.checked;

      askBtn.disabled = true;
      askBtn.textContent = "Consultando...";

      try {
        const res = await callBackend(q, k, useMock);
        // mostrar solo si supera threshold
        if (res.confidencePct < minC) {
          res.respuesta = "No encontré suficiente respaldo en los documentos (confianza baja). Requiere revisión humana.";
          res.pasos = [];
        }
        showResponse(res);
      } catch (err) {
        alert("Error: " + err.message);
      } finally {
        askBtn.disabled = false;
        askBtn.textContent = "Consultar";
      }
    });

    // start: render initial fragments
    renderFragments(MOCK_FRAGMENTS.slice(0,3));
  </script>
</body>
</html>
